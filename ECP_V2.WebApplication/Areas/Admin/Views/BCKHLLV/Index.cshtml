@{
    ViewBag.Title = "Kế hoạch lịch làm việc";
    Layout = "~/Views/Shared/_LayoutHome.cshtml";
}
@{
    var donViRepository = new ECP_V2.Business.Repository.DonViRepository();
    string donviId = Session["DonViID"].ToString();
    var donVi = donViRepository.GetById(Session["DonViID"].ToString());
}

<link href="@Url.Content("~/Content/jquery-ui-themes-1.12.1/jquery-ui.theme.css")" rel="stylesheet" />
<link href="@Url.Content("~/Content/jquery-ui-themes-1.12.1/jquery-ui.css")" rel="stylesheet" />



@*Modal cập nhật hoãn hủy*@
<div id="modalCanCel" class="zoom-anim-dialog modal-block modal-block-primary mfp-hide" style=" background-color:white ">
    <section class="panel">
        <header class="panel-heading">
            <h2 class="panel-title">Thay đổi kế hoạch làm việc</h2>
        </header>
        <div style="margin-left: 5px; margin-right: 5px;">
            <div class="control-group">
                <label for="textfield" class="control-label">Lý do cập nhật</label>
                <div class="controls">
                    <textarea id="LyDoHoanHuy" name="LyDoHoanHuy" class="input-block-level" placeholder="Nhập..." rows="3"></textarea>
                </div>
            </div>

            <!-- Select 1 -->
            <div class="control-group">
                <label for="PhienLamViecId" class="control-label">Lịch làm việc thay thế</label>
                <select id="PhienLamViecId" class="form-control">
                    @*<option value="">Không</option>
                        <optgroup label="Lịch đã duyệt">
                            @{ Html.RenderAction("DanhSachPLVChuaKiemTra", "KeHoachLichLV", new { NgayLamViec = "2024-12-23" }); }
                        </optgroup>*@
                </select>
            </div>

            <!-- Select 2 -->
            <div class="control-group">
                <label for="HinhThucKiemTra" class="control-label">Hình thức kiểm tra</label>
                <div class="controls">
                    <select id="HinhThucKiemTra" class="form-control">
                        @*<option value="">Không</option>*@
                        <option value="1">Kiểm tra đầu giờ</option>
                        <option value="2">Kiểm tra giữa giờ</option>
                    </select>
                </div>
            </div>

            <!-- Hidden input for NguoiDaiDienKT -->
            <input type="hidden" id="NguoiDaiDienKT" name="NguoiDaiDienKT" />
            <input type="hidden" id="IdKeHoachHuy" name="IdKeHoachHuy" />
            <input type="hidden" id="IdPLV" name="IdPLV" />

            <!-- Select 3 -->
            <div class="control-group">
                <label for="NguoiDaiDienKT_Id" class="control-label">Đại diện đoàn KT hiện trường</label>
                <select id="NguoiDaiDienKT_Id" class="form-control">
                    @*<option value="">Không</option>*@
                    <optgroup label="Lãnh đạo công việc">
                        @{ Html.RenderAction("DanhSachNhanVien", "PhienLV", new { roles = "LanhDaoCongViec" }); }
                    </optgroup>
                </select>
            </div>

            <footer class="panel-footer">
                <div class="row">
                    <div class="col-md-12 text-right">
                        <button class="btn btn-primary" type="button" id="modal-confirm" onclick="UpdateHoanHuy()">Lưu</button>
                        <button class="btn btn-default modal-dismiss" type="button" onclick="ModalDismissKHLLV()" id="modal-dismiss">Thoát</button>
                    </div>
                </div>
            </footer>

        </div>
    </section>
</div>

<div class="block-fluid">
    <div class="panel panel-visible">
        <div class="panel-heading br-b-n">
            <div class="panel-title hidden-xs">
                <div class="panel-actions">
                    <a href="~/Admin/Report/Index" class="mb-xs mt-xs mr-xs btn btn-primary" style="cursor:pointer;width:105px;height:28px;line-height:0; float: right;" id="export_tuan_cty">
                        <i class="fa fa-file-excel-o"></i> &nbsp; Báo cáo
                    </a>
                    @if (donVi != null)
                    {
                        if (((donviId.Length == 4 && donVi.DviCha.Equals("PA")) || donviId.ToUpper().Equals("PH") || donviId.ToUpper().Equals("PN") || donviId.ToUpper().Equals("PM")))
                        {

                        }
                        else
                        {
                            if (User.IsInRole("Manager"))
                            {
                                <a href="#modalAnimTongHop" id="btnTongHopBaoCaoCuoiNgay" class="mb-xs mt-xs mr-xs btn btn-primary" style="cursor:pointer; float: right; width: 230px; height: 28px; line-height:0;">
                                    <i class="fa fa-file-excel-o"></i> &nbsp; Tổng hợp báo cáo cuối ngày
                                </a>
                            }
                        }
                    }
                    <a href="#modalAnimTongHopAlert" id="btnTongHopBaoCaoCuoiNgayAlert" class="mb-xs mt-xs mr-xs btn btn-primary" style="cursor:pointer; float: right; width: 230px; height: 28px; line-height:0; display: none;">
                    </a>
                    <div id="datatable-default_filter" class="dataTables_filter" style="margin-right: 10px; float: right;margin-left:10px">
                        <input class="form-control" type="text" placeholder="Tìm kiếm..." id="txtSearch" onkeypress="txtSearch_onKeyPress(event,this)"
                               onkeyup="txtSearch_onkeyup(event,this)" />
                    </div>
                    <select class="form-control" style="width:140px;" onchange="loaibieudo_change(this)" id="drlLoaiBieuDo">
                        <option value="DS" selected="selected">Kiểu danh sách</option>
                        <option value="BD">Kiểu bản đồ</option>
                    </select>
                </div>
                <span class="glyphicon glyphicon-tasks"></span> Kế hoạch lịch làm việc
            </div>
        </div>
        <div class="panel-body pn">
            <div class="text-center">
                @if (TempData["Notification"] != null)
                {
                    @Html.Hidden("NotificationAutoHide", TempData["NotificationAutoHide"])
                    <div id="NotificationBox" class="@TempData["NotificationCSS"]" style="display: none">
                        @Html.Raw(@TempData["Notification"])
                    </div>
                }
            </div>
            <div id="datatable_wrapper" class="dataTables_wrapper form-inline dt-bootstrap no-footer">
                <div class="row show-grid">
                    <div class="col-md-4">
                        <span>Đơn Vị: &nbsp;</span>
                        <select class="form-control" id="cmbDonViID" onchange="donvi_change(this)">
                            @try
                            {
                                @Html.Raw(ECP_V2.Business.Repository.DonViRepository.GetAllDonViHtml2(Session["DonViID"].ToString()))
                            }
                            catch { }
                        </select>
                    </div>
                    <div class="col-md-4">
                        <span>Phòng Ban : &nbsp;</span>
                        @if (Session["DonViID"].ToString() == "PA")
                        {
                            <select style="width:166px" class="form-control" id="cmbPhongBan" onchange="phongban_change(this)"></select>
                        }
                        else
                        {
                            <select style="width:166px" class="form-control" id="cmbPhongBan" onchange="phongban_change(this)">
                                <option value="">Chọn phòng ban</option>
                                @try
                                {
                                    @Html.Raw(ECP_V2.Business.Repository.PhongBanRepository.GetPhongBanByDonViIDHtml(Session["DonViID"].ToString(), 0))
                                }
                                catch { }
                            </select>
                        }
                    </div>
                    <div class="col-md-4">
                        <span>TC Phiên : &nbsp;</span>
                        <select class="form-control" id="cmbTCPhien" onchange="tcphien_change(this) ">
                            <option value="0">Tất cả</option>
                            @if (ViewBag.ListTCPhien != null)
                            {
                                var listTCPhien = (List<ECP_V2.DataAccess.plv_TinhChatPhien>)ViewBag.ListTCPhien;
                                <option value="0">Tất cả</option>
                                foreach (var item in listTCPhien)
                                {
                                    <option value="@item.Id">@item.Name</option>
                                }
                            }
                        </select>
                    </div>
                </div>
                <hr class="mt-md mb-md">
                <div class="row show-grid">
                    <div class="col-md-2">
                        <span>Từ ngày: &nbsp;</span>
                        <input id="GioBd" type="text" placeholder="Thời gian bắt đầu">
                    </div>
                    <div class="col-md-2" id="content-denngay">
                        <span>Đến ngày: </span>
                        <input id="GioKt" type="text" placeholder="Thời gian kết thúc" onchange="end_chage()">
                    </div>
                    <div class="col-md-2" style="margin-left:10px">
                        <span>Phiếu ký: &nbsp;</span>
                        <br />
                        <select class="form-control" id="cmdPhieuKy" @*onchange="cmbDuyetNPC_change(this)"*@>
                            <option value="-1">Tất cả</option>
                            <option value="0">Hoàn thiện phiếu ký</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <span> &nbsp; Cắt điện: &nbsp;</span>
                        <select class="form-control" id="cmbTTPhienCatDien" onchange="ttphiencatdien_change(this)">
                            <option value="0">Tất cả</option>
                            @if (ViewBag.ThuocTinhPhienCatDien != null)
                            {
                                var list = (List<ECP_V2.DataAccess.plv_ThuocTinhPhien>)ViewBag.ThuocTinhPhienCatDien;

                                foreach (var item in list)
                                {
                                    <option value="@item.Id">@item.TenThuocTinh</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <span> &nbsp; Tiếp địa: &nbsp;</span>
                        <select class="form-control" id="cmbTTPhienTiepDia" onchange="ttphientiepdia_change(this)">
                            <option value="0">Tất cả</option>
                            @if (ViewBag.ThuocTinhPhienTiepDia != null)
                            {
                                var list = (List<ECP_V2.DataAccess.plv_ThuocTinhPhien>)ViewBag.ThuocTinhPhienTiepDia;

                                foreach (var item in list)
                                {
                                    <option value="@item.Id">@item.TenThuocTinh</option>
                                }
                            }
                        </select>
                    </div>
                </div>
                <div class="row ">
                    <div class="col-md-2 ">
                        <span> &nbsp; Khác: &nbsp;</span>
                        <select class="form-control" id="cmbTTPhienKhac" onchange="ttphienkhac_change(this)">
                            <option value="0">Tất cả</option>
                            @if (ViewBag.ThuocTinhPhien5 != null)
                            {
                                var list = (List<ECP_V2.DataAccess.plv_ThuocTinhPhien>)ViewBag.ThuocTinhPhien5;

                                foreach (var item in list)
                                {
                                    <option value="@item.Id">@item.TenThuocTinh</option>
                                }
                            }
                        </select>
                    </div>
                </div>
                <hr class="mt-md mb-md">

                @if (User.IsInRole("DuyetViec"))
                {
                    <div class="row show-grid">
                        <div class="col-md-2">
                            <span>Trạng thái: &nbsp;</span>
                            <br />
                            <select class="form-control" id="cmbTTPhien" onchange="ttphien_change(this)" disabled>
                                <option value="0">Đã duyệt</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <span>Duyệt NPC: &nbsp;</span>
                            <br />
                            <select class="form-control" id="cmbDuyetNPC" @*onchange="cmbDuyetNPC_change(this)"*@>
                                <option value="-1">Tất cả</option>
                                <option value="0">Chưa chuyển NPC</option>
                                <option value="1">Đã chuyển NPC</option>
                            </select>
                        </div>
                        @*@if (donVi != null)
                            {
                                if (((donviId.Length == 4 && donVi.DviCha.Equals("PA")) || donviId.ToUpper().Equals("PH") || donviId.ToUpper().Equals("PN") || donviId.ToUpper().Equals("PM")))
                                {

                                }
                                else
                                {
                                    <div class="col-md-2">
                                        <a href="#modalAnimDuyetAll" class="mb-xs mt-xs mr-xs btn btn-primary" style="cursor:pointer;padding: 3px 9px;" id="DuyetAll">
                                            <i class="fa fa-check-circle"></i> &nbsp; Báo cáo
                                        </a>
                                    </div>
                                }
                            }

                            @if (User.IsInRole("DuyetNPC"))
                            {
                                <div class="col-md-2">
                                    <a href="#modalAnimGuiNPCAll" class="mb-xs mt-xs mr-xs btn btn-primary" style="cursor:pointer;padding: 3px 9px;" id="DuyetNPC">
                                        <i class="fa fa-check-circle"></i> &nbsp; Gửi công việc NPC
                                    </a>
                                </div>
                            }*@
                        @*<div class="col-md-2">
                                <a href="#modalAnimDeleteMultiple" class="mb-xs mt-xs mr-xs btn btn-primary" style="cursor:pointer;padding: 3px 9px;" id="XoaDanhSach">
                                    <i class="fa fa-check-circle"></i> &nbsp; Xóa danh sách
                                </a>
                            </div>*@
                        <div class="col-md-2">
                            <a href="#" class="mb-xs mt-xs mr-xs btn btn-primary" onclick="xuatExcel()" style="cursor:pointer;padding: 3px 9px;" id="xuatexcel123">
                                <i class="fa fa-file-excel-o"></i> &nbsp; Xuất excel
                            </a>
                        </div>
                        <div class="col-md-2">
                            <a class="mb-xs mt-xs mr-xs btn btn-primary" style="cursor:pointer;width:200px;height:28px;line-height:0; float: right;" id="export_tuan_cty">
                                <i class="fa fa-file-excel-o"></i> &nbsp; Báo cáo giao ban AT
                            </a>
                        </div>
                    </div>


                }
                else
                {
                    <div class="row show-grid">
                        @if (User.IsInRole("Manager") || User.IsInRole("Leader") || User.IsInRole("Admin") || User.IsInRole("Master") || User.IsInRole("AdminDonVi"))
                        {
                            <div class="col-md-2">
                                <span>Trạng thái: &nbsp;</span>
                                <br />
                                <select class="form-control" id="cmbTTPhien" onchange="ttphien_change(this)">
                                    <option value="0">Tất cả</option>
                                    @if (ViewBag.ListTTPhien != null)
                                    {
                                        var listTTPhien = (List<ECP_V2.DataAccess.plv_TrangThaiPhien>)ViewBag.ListTTPhien;

                                        foreach (var item in listTTPhien)
                                        {
                                            <option value="@item.Id">@item.Name</option>
                                        }
                                    }
                                </select>
                            </div>

                            <div class="col-md-2">
                                <span>Duyệt NPC: &nbsp;</span>
                                <br />
                                <select class="form-control" id="cmbDuyetNPC" @*onchange="cmbDuyetNPC_change(this)"*@>
                                    <option value="-1">Tất cả</option>
                                    <option value="0">Chưa chuyển NPC</option>
                                    <option value="1">Đã chuyển NPC</option>
                                </select>
                            </div>

                        }
                        @if (User.IsInRole("DuyetNPC"))
                        {
                            <div class="col-md-2">
                                <a href="#modalAnimGuiNPCAll" class="mb-xs mt-xs mr-xs btn btn-primary" style="cursor:pointer;padding: 3px 9px;" id="DuyetNPC">
                                    <i class="fa fa-check-circle"></i> &nbsp; Gửi công việc NPC
                                </a>
                            </div>
                        }

                        <div class="col-md-2">
                            <a href="#modalAnimDeleteMultiple" class="mb-xs mt-xs mr-xs btn btn-primary" style="cursor:pointer;padding: 3px 9px;" id="DuyetNPC">
                                <i class="fa fa-check-circle"></i> &nbsp; Xóa danh sách
                            </a>
                        </div>

                    </div>
                }

                <div class="listRolesName list" style="margin-top: 5px;">
                    @{Html.RenderAction("List", "PhienLV", new
                        {
                            page = 1,
                            pageSize = 500,
                            filter = "",
                            tcphien = ViewBag.TinhChat,
                            catdien = 0,
                            tiepdia = 0,
                            khac = 0,
                            DateFrom = ViewBag.TuNgay,
                            DateTo = ViewBag.DenNgay,
                            DonViId = (ViewBag.DonViID != null) ? ViewBag.DonViID : Session["DonViID"].ToString(),
                            ttPhien = 0,
                            chuyenNPC = -1,
                            phieuky = -1,
                            isShowBtnHoanHuy = true
                        });}
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modalAnimDeleteKHLLV" class="zoom-anim-dialog modal-block modal-block-primary mfp-hide">
    <section class="panel">
        <header class="panel-heading">
            <h2 class="panel-title">Thông báo</h2>
        </header>
        <div class="panel-body">
            <div class="modal-wrapper">
                <div class="modal-icon">
                    <i class="fa fa-question-circle"></i>
                </div>
                <div class="modal-text">
                    <h3>Bạn có chắc muốn xóa kế hoạch kiểm tra này ?</h3>
                </div>
            </div>
        </div>
        <footer class="panel-footer">
            <div class="row">
                <div class="col-md-12 text-right">
                    <button class="btn btn-primary modal-confirm" onclick="DeleteKeHoach()" id="modal-confirm">Có</button>
                    <button class="btn btn-default modal-dismiss" onclick="DeleteMultipleModalDismiss()" id="modal-dismiss">Không</button>
                </div>
            </div>
        </footer>
    </section>
</div>

<div id="scrollbottom" style="overflow-x: scroll; overflow-y: hidden; height: 20px; width: 300px; position: fixed; bottom: 0px; right: 55px; background-color: #9E9E9E; border-radius: 6px; border: 1px solid #9E9E9E;">
    <div id="scrollbottomcontent" style="height:23px; width:600px"></div>
</div>
<script>
    $("#scrollbottom").scroll(function () {
        var getRet = ($(this).scrollLeft() / 302) * 100;
        yourFunction(getRet);
    });

    function yourFunction(retag) {
        try {
            $(".table-responsive").scrollLeft((6000 / 100) * retag);
        } catch (e) {

        }
    }
</script>
<style>

    .container-fluid {
        padding-left: 0;
        padding-right: 0;
    }

    .content-body {
        padding: 5px;
    }
</style>
@section JavaScriptOnePgae{
    @Scripts.Render("~/Scripts/jquery-unified-export-file-1.0.min.js")
    <script type="text/javascript">

        var IdDetail = 0, IdDuyet = 0,IdKetThuc=0;
        var IdDelete = 0;
        var IdUpdateVuaTao = 0;
        var IdUpdateSoPhieu = 0;
        var NoiDungDelete = 0;
        var IdSign = 0;
        $(function () {

            $.datepicker?.setDefaults({

                buttonImageOnly: true,
                //buttonImage: "calendar.gif",
                regional: "vn",
                dateFormat: 'dd/mm/yyyy'
            });

            //Menu Collapsed Layout
            $('html').addClass('sidebar-left-collapsed');
            var yNgay = '@(ViewBag.TuNgay != null?ViewBag.TuNgay : DateTime.Now)'.split(' ')[0];

            ////var tuNgay = kendo.toString(kendo.parseDate('@(ViewBag.TuNgay!=null?ViewBag.TuNgay:DateTime.Now)', 'dd/MM/yyyy'), 'dd/MM/yyyy');
            var start = $("#GioBd").datepicker({
                dateFormat: 'dd/mm/yy'
            }).val(yNgay);
              var xNgay = '@(ViewBag.DenNgay != null?ViewBag.DenNgay : DateTime.Now)'.split(' ')[0];

            var end = $("#GioKt").datepicker({
            dateFormat: 'dd/mm/yy',
            onSelect: function () {
            end_chage();
            }}).val(xNgay);

            //khai bao Popup cho nut duyet
            $('#DuyetAll').magnificPopup({
                type: 'inline',
                fixedContentPos: false,
                fixedBgPos: true,
                overflowY: 'auto',
                closeBtnInside: true,
                preloader: false,
                midClick: true,
                removalDelay: 300,
                mainClass: 'my-mfp-zoom-in',
                modal: true
            }).click(function () {
            });

            $('#DuyetNPC').magnificPopup({
                type: 'inline',
                fixedContentPos: false,
                fixedBgPos: true,
                overflowY: 'auto',
                closeBtnInside: true,
                preloader: false,
                midClick: true,
                removalDelay: 300,
                mainClass: 'my-mfp-zoom-in',
                modal: true
            }).click(function () {
            });

            $('#XoaDanhSach').magnificPopup({
                type: 'inline',
                fixedContentPos: false,
                fixedBgPos: true,
                overflowY: 'auto',
                closeBtnInside: true,
                preloader: false,
                midClick: true,
                removalDelay: 300,
                mainClass: 'my-mfp-zoom-in',
                modal: true
            }).click(function () {
            });

            $('a#btnTongHopBaoCaoCuoiNgay').magnificPopup({
                type: 'inline',
                fixedContentPos: false,
                fixedBgPos: true,
                overflowY: 'auto',
                closeBtnInside: true,
                preloader: false,
                midClick: true,
                removalDelay: 300,
                mainClass: 'my-mfp-zoom-in',
                modal: true
            }).click(function () {
                ModalConfirmTongHop();
            });
            //Tạm rào để test ko dùng kendo
            //$("#txtNgayTongHop").kendoDatePicker({
            //    format: 'dd/MM/yyyy',
            //    value: new Date()
            //}).data("kendoDatePicker");

            var dNgay = '@(DateTime.Now)'.split(' ')[0];

            $("#txtNgayTongHop").datepicker({
                dateFormat: 'dd/MM/yy'
            }).val(dNgay);

            $('a#btnTongHopBaoCaoCuoiNgayAlert').magnificPopup({
                type: 'inline',
                fixedContentPos: false,
                fixedBgPos: true,
                overflowY: 'auto',
                closeBtnInside: true,
                preloader: false,
                midClick: true,
                removalDelay: 300,
                mainClass: 'my-mfp-zoom-in',
                modal: true
            }).click(function () {
            });

            $('#cmbDuyetNPC').change(function () {
                Paging(1, 500, $('#txtSearch').val(), $('#cmbTCPhien').val(), $('#cmbTTPhienCatDien').val(), $('#cmbTTPhienTiepDia').val(), $('#cmbTTPhienKhac').val(), $('#GioBd').val(), $('#GioKt').val(), $('#cmbDonViID').val(), $('#cmbPhongBan').val(), $(this).val());
            });

            @if(ViewBag.DonViID != null)
            {
                <text>
            var dvElement = document.getElementById('cmbDonViID');
            $('#cmbDonViID').val('@ViewBag.DonViID');
            donvi_change(dvElement);
                </text>

            }

            $("#cmbTCPhien option[value='@Html.Raw(ViewBag.TinhChat)']").attr("selected", true);
            $('#cmbTCPhien').trigger("chosen:updated");
            ////$("#cmbTCPhien").val('@Html.Raw(ViewBag.TinhChat)').change();

        });

        function loaibieudo_change(el) {
            Paging(1, 500, $('#txtSearch').val(), $('#cmbTCPhien').val(), $('#cmbTTPhienCatDien').val(), $('#cmbTTPhienTiepDia').val(), $('#cmbTTPhienKhac').val(), $('#GioBd').val(), $('#GioKt').val(), $('#cmbDonViID').val(), $('#cmbPhongBan').val(), $('#cmbDuyetNPC').val());
        }

        function end_chage() {
            Paging(1, 500, $('#txtSearch').val(), $('#cmbTCPhien').val(), $('#cmbTTPhienCatDien').val(), $('#cmbTTPhienTiepDia').val(), $('#cmbTTPhienKhac').val(), $('#GioBd').val(), $('#GioKt').val(), $('#cmbDonViID').val(), $('#cmbPhongBan').val(), $('#cmbDuyetNPC').val());
        }

        function donvi_change(el) {
            LoadPhongBanByDonVi(el.value);
            Paging(1, 500, $("#txtSearch").val(), $('#cmbTCPhien').val(), $('#cmbTTPhienCatDien').val(), $('#cmbTTPhienTiepDia').val(), $('#cmbTTPhienKhac').val(), $('#GioBd').val(), $('#GioKt').val(), el.value, $('#cmbPhongBan').val(), $('#cmbDuyetNPC').val());
        }

        function tcphien_change(el) {
            Paging(1, 500, $('#txtSearch').val(), el.value, $('#cmbTTPhienCatDien').val(), $('#cmbTTPhienTiepDia').val(), $('#cmbTTPhienKhac').val(), $('#GioBd').val(), $('#GioKt').val(), $('#cmbDonViID').val(), $('#cmbPhongBan').val(), $('#cmbDuyetNPC').val());
        }

        function ttphien_change(el) {

            Paging(1, 500, $('#txtSearch').val(), $('#cmbTCPhien').val(), $('#cmbTTPhienCatDien').val(), $('#cmbTTPhienTiepDia').val(), $('#cmbTTPhienKhac').val(), $('#GioBd').val(), $('#GioKt').val(), $('#cmbDonViID').val(), $('#cmbPhongBan').val(), $('#cmbDuyetNPC').val());

        }

        function xuatExcel() {

          console.log('abc',$('#cmbTCPhien').val(), $('#cmbTTPhienCatDien').val(), $('#cmbTTPhienTiepDia').val(), $('#cmbTTPhienKhac').val(), $('#GioBd').val(), $('#GioKt').val(), $('#cmbDonViID').val(), $('#cmbPhongBan').val(), $('#cmbDuyetNPC').val());
            XuatExcelFunction( $('#cmbTCPhien').val(), $('#cmbTTPhienCatDien').val(), $('#cmbTTPhienTiepDia').val(), $('#cmbTTPhienKhac').val(), $('#GioBd').val(), $('#GioKt').val(), $('#cmbDonViID').val(), $('#cmbPhongBan').val(), $('#cmbDuyetNPC').val())
        }

        ////Xuất báo cáo tuần theo mẫu công ty
        //$('#export_tuan_cty').bind('click', function () {
        //    $.UnifiedExportFile(
        //        {
        //            action: "/Admin/PhienLV/Export_Cty",
        //            data: {
        //                filter: '',
        //                tcphien: $('#cmbTCPhien').val() || 0,
        //                trangThai: $('#cmbTTPhien').val() || 0,
        //                DateFrom: $('#GioBd').val(),
        //                DateTo: $('#GioKt').val(),
        //                DonViId: $('#cmbDonViID').val() || '',
        //                PhongBanId: $('#cmbPhongBan').val() || 0,
        //                isExportExcel: true
        //            },
        //            downloadType: 'Progress',
        //            ajaxLoadingSelector: '#loading'
        //        });
        //});

        function ttphiencatdien_change(el) {

            Paging(1, 500, $('#txtSearch').val(), $('#cmbTCPhien').val(), el.value, $('#cmbTTPhienTiepDia').val(), $('#cmbTTPhienKhac').val(), $('#GioBd').val(), $('#GioKt').val(), $('#cmbDonViID').val(), $('#cmbPhongBan').val(), $('#cmbDuyetNPC').val());

        }

        function ttphientiepdia_change(el) {
                Paging(1, 500, $('#txtSearch').val(), $('#cmbTCPhien').val(), $('#cmbTTPhienCatDien').val(), el.value, $('#cmbTTPhienKhac').val(), $('#GioBd').val(), $('#GioKt').val(), $('#cmbDonViID').val(), $('#cmbPhongBan').val(), $('#cmbDuyetNPC').val());

        }

        function ttphienkhac_change(el) {

            Paging(1, 500, $('#txtSearch').val(), $('#cmbTCPhien').val(), $('#cmbTTPhienCatDien').val(), $('#cmbTTPhienTiepDia').val(), el.value, $('#GioBd').val(), $('#GioKt').val(), $('#cmbDonViID').val(), $('#cmbPhongBan').val(), $('#cmbDuyetNPC').val());
        }

        function Paging(page, pageSize, filter, tcphien, catdien, tiepdia, khac, DateFrom, DateTo, DonViId, PhongBanId, chuyenNPC, phieuky) {
            loading('Đang tải dữ liệu...', 1);
            $("#preloader").unbind("click");
            $('#preloader').click(function () {
                unloading();
            })
            var ttPhien = 0;
            var cbTTPhienSelect = $('#cmbTTPhien').val();
            var userRoleDuyet = '@(Request.IsAuthenticated && User.IsInRole("DuyetViec")) ? "true" : "false")';
            if (userRoleDuyet && cbTTPhienSelect != "") {
                ttPhien = cbTTPhienSelect;
            }
            else {

                ttPhien = 0;
            }

            if (typeof (ttPhien) === 'undefined') {
                ttPhien = 0;
            }

            var scriptUrl = "/Admin/PhienLV/List";
            $.ajax({
                url: scriptUrl,
                data: {
                    page: page,
                    pageSize: pageSize,
                    filter: filter,
                    tcphien: tcphien,
                    catdien: catdien,
                    tiepdia: tiepdia,
                    khac: khac,
                    DateFrom: DateFrom,
                    DateTo: DateTo,
                    DonViId: DonViId,
                    PhongBanId: PhongBanId,
                    ttPhien: ttPhien,
                    chuyenNPC: chuyenNPC,
                    phieuky: phieuky,
                    isShowBtnHoanHuy:true,
                    LoaiBieuDo: $('#drlLoaiBieuDo').val()
                },
                type: 'GET',
                dataType: 'html',
                async: false,
                success: function (data) {
                    $(".list").html("");
                    $(".list").html(data);

                    $("#drlPageSize").val(pageSize);
                    $("#txtSearch").val(filter);

                    unloading();
                }
            });
        }


        function XuatExcelFunction( tcphien, catdien, tiepdia, khac, DateFrom, DateTo, DonViId, PhongBanId, chuyenNPC, phieuky) {
         loading('Đang xuất file...', 1);

         var ttPhien = 0;
         var cbTTPhienSelect = $('#cmbTTPhien').val();
         var userRoleDuyet = '@(Request.IsAuthenticated && User.IsInRole("DuyetViec")) ? "true" : "false")';
         if (userRoleDuyet && cbTTPhienSelect != "") {
             ttPhien = cbTTPhienSelect;
         }
         else {

             ttPhien = 0;
         }

            console.log('DonViId', DonViId)

         if (typeof (ttPhien) === 'undefined') {
             ttPhien = 0;
         }

            var scriptUrl = "/Admin/PhienLV/XuatExcelBCKHLLV";

                $.UnifiedExportFile(
                    {
                        action: scriptUrl,
                        data: {
                            tcphien: tcphien,
                            catdien: catdien,
                            tiepdia: tiepdia,
                            khac: khac,
                            DateFrom: DateFrom,
                            DateTo: DateTo,
                            DonViId: DonViId,
                            PhongBanId: PhongBanId,
                            ttPhien: ttPhien,
                            chuyenNPC: chuyenNPC,
                            phieuky: phieuky,
                            isShowBtnHoanHuy: true,
                            LoaiBieuDo: $('#drlLoaiBieuDo').val()
                        },
                        downloadType: 'Progress',
                        ajaxLoadingSelector: '#loading'
                    });


        };


        function pagelength_change(el) {

            Paging(1, el.value, $('#txtSearch').val(), $('#cmbTCPhien').val(), $('#cmbTTPhienCatDien').val(), $('#cmbTTPhienTiepDia').val(), $('#cmbTTPhienKhac').val(), $('#GioBd').val(), $('#GioKt').val(), $('#cmbDonViID').val(), $('#cmbPhongBan').val(), $('#cmbDuyetNPC').val(), $('#cmdPhieuky').val());

        }

        function txtSearch_onKeyPress(e, el) {
            var key;
            if (window.event)
                key = window.event.keyCode;     //IE
            else
                key = e.which;     //firefox

            if (key == 13) {

                Paging(1, 500, el.value, $('#cmbTCPhien').val(), $('#cmbTTPhienCatDien').val(), $('#cmbTTPhienTiepDia').val(), $('#cmbTTPhienKhac').val(), $('#GioBd').val(), $('#GioKt').val(), $('#cmbDonViID').val(), $('#cmbPhongBan').val(), $('#cmbDuyetNPC').val());

            }
        }

        function txtSearch_onkeyup(e, el) {
            if (el.value == '') {
                Paging(1, 500, el.value, $('#cmbTCPhien').val(), $('#cmbTTPhienCatDien').val(), $('#cmbTTPhienTiepDia').val(), $('#cmbTTPhienKhac').val(), $('#GioBd').val(), $('#GioKt').val(), $('#cmbDonViID').val(), $('#cmbPhongBan').val(), $('#cmbDuyetNPC').val());

            }
        }


        function ModalDismissKHLLV() {
            $.magnificPopup.close();
        }


        function DetailPhienLv(PhienLvId) {

            loading('Đang tải dữ liệu...', 1);
            $("#preloader").unbind("click");
            $('#preloader').click(function () {
                unloading();
            })

            $.ajax({
                type: "GET",
                url: '/Admin/PhienLV/DetailPhienLv?Id=' + PhienLvId,
                success: function (json) {

                    $('#modalAnimDetail .modal-wrapper').html('');
                    $('#modalAnimDetail .modal-wrapper').html(json);
                    $('a.chi-tiet-phien-lv').prop('href', '/Admin/PhienLV/ChiTietPhienLV/' + PhienLvId);

                    unloading();
                }
            });

        }


        function DetailPhieuCongTac(PhienLvId) {

            loading('Đang tải dữ liệu...', 1);
            $("#preloader").unbind("click");
            $('#preloader').click(function () {
                unloading();
            })

            $.ajax({
                type: "GET",
                url: '/Admin/PhienLV/DetailPhieuCongTac?Id=' + PhienLvId,
                success: function (json) {

                    $('#modalAnimDetailPCT .modal-wrapper').html('');
                    $('#modalAnimDetailPCT .modal-wrapper').html(json);

                    unloading();
                }
            });

        }
        function AddHoanHuy(date) {

            loading('Đang tải dữ liệu...', 1);
            $("#preloader").unbind("click");
            $('#preloader').click(function () {
                unloading();
            })

            $.ajax({
                type: "GET",
                url: '/Admin/PhienLV/DanhSachPLVChuaKiemTra?NgayLamViec=' + date,
                success: function (json) {

                    $('#PhienLamViecId').html('');
                    $('#PhienLamViecId').html(json);

                    unloading();
                }
            });

        }

        function UpdateHoanHuy() {

            // Hiển thị preloader khi đang tải dữ liệu
            loading('Đang tải dữ liệu...', 1);
            $("#preloader").unbind("click");
            $('#preloader').click(function () {
                unloading();
            });
            var lyDoHoanHuy = $('#LyDoHoanHuy').val()
            if (!lyDoHoanHuy || lyDoHoanHuy.trim() === "") {
                new PNotify({
                    title: 'Lỗi!',
                    text: 'Nhập lý do hoãn hủy!',
                    type: 'error'
                });
                return false;
            }
            // Lấy các giá trị từ form
            var selectedOption = $("#NguoiDaiDienKT_Id option:selected");
            var selectedText = selectedOption.text();
            var formData = {
                PhienLamViecId: $('#PhienLamViecId').val(),
                HinhThucKiemTra: $('#HinhThucKiemTra').val(),
                NguoiDaiDienKT_Id: $('#NguoiDaiDienKT_Id').val(),
                NguoiDaiDienKT: selectedText,
                LyDoHoanHuy: lyDoHoanHuy,
                Id: $('#IdKeHoachHuy').val()
            };
            $.ajax({
                type: "POST",
                url: '/Admin/PhienLV/UpdateHoanHuy',
                data: formData,
                success: function (response) {
                    if (response.success) {
                        new PNotify({
                            title: 'Thông báo!',
                            text: 'Cập nhật thành công!',
                            type: 'success'
                        });
                        end_chage();
                        ModalDismissKHLLV();
                    } else {
                        new PNotify({
                            title: 'Lỗi!',
                            text: response.message,
                            type: 'error'
                        });
                    }
                },
                error: function (xhr, status, error) {
                    new PNotify({
                        title: 'Lỗi!',
                        text: 'Đã xảy ra lỗi khi gửi dữ liệu!',
                        type: 'error'
                    });
                },
                complete: function () {
                    unloading();
                }
                });
        };



        function DeleteKeHoach() {
            var IdDelete = $('#IdKeHoachHuy').val()
            if (IdDelete != "") {

                loading('Đang xử lý...', 1);

                $.ajax({
                    type: "GET",
                    contentType: "application/json; charset=utf-8",
                    url: '/Admin/PhienLV/Delete_KeHoachLLV',
                    data:
                    {
                        "Id": IdDelete,
                    },
                    dataType: "json",
                    beforeSend: function () {
                    },
                    success: function (response) {
                        unloading();
                        if (response.success) {
                            new PNotify({
                                title: 'Thông báo!',
                                text: 'Xóa kế hoạch thành công',
                                type: 'success'
                            });
                            end_chage();
                        }
                        else {
                            new PNotify({
                                title: 'Thông báo!',
                                text: 'Lỗi : ',
                                type: 'error'
                            });
                        }
                    }
                });
            }
            else {
                new PNotify({
                    title: 'Thông báo!',
                    text: 'Lỗi : ' + data,
                    type: 'error'
                });
            }
            $.magnificPopup.close();
        }


        function ModalConfirmComment(el) {
            $("#AddComment").submit();
        }
        function ModalConfirmCommentHoanHuy(el) {
            $("#UpdateHoanHuy").submit();
        }

        function LoadPhongBanByDonVi(DonViId) {

            $.ajax({
                url: "/Admin/PhienLV/CmbPhongBan",
                data: {
                    DonViId: DonViId
                },
                type: 'GET',
                dataType: 'html',
                async: false,
                success: function (data) {

                    $('#cmbPhongBan').html("");
                    $('#cmbPhongBan').html(data);

                }
            });
        }

        function phongban_change(el) {

            Paging(1, 500, $("#txtSearch").val(), $('#cmbTCPhien').val(), $('#cmbTTPhienCatDien').val(), $('#cmbTTPhienTiepDia').val(), $('#cmbTTPhienKhac').val(), $('#GioBd').val(), $('#GioKt').val(), $('#cmbDonViID').val(), el.value, $('#cmbDuyetNPC').val());

        }




        function DeleteMultipleModalDismiss() {
            $.magnificPopup.close();
        }

        function DeleteModalDismiss() {
            $.magnificPopup.close();
        }

        function DeleteModalConfirm() {

            if (IdDelete != "") {

                loading('Đang xử lý...', 1);

                $.ajax({
                    type: "GET",
                    contentType: "application/json; charset=utf-8",
                    url: '/Admin/PhienLV/DeletePhienLv',
                    data:
                    {
                        "Id": IdDelete,
                        "NoiDung": NoiDungDelete
                    },
                    dataType: "json",
                    beforeSend: function () {//alert(id);
                    },
                    success: function (data) {
                        unloading();
                        if (data == "") {
                            new PNotify({
                                title: 'Thông báo!',
                                text: 'Xóa phiên làm việc thành công',
                                type: 'success'
                            });

                            Paging(1, 500, $("#txtSearch").val(), $('#cmbTCPhien').val(), $('#cmbTTPhienCatDien').val(), $('#cmbTTPhienTiepDia').val(), $('#cmbTTPhienKhac').val(), $('#GioBd').val(), $('#GioKt').val(), $('#cmbDonViID').val(), $('#cmbPhongBan').val(), $('#cmbDuyetNPC').val());
                        }
                        else {
                            new PNotify({
                                title: 'Thông báo!',
                                text: 'Lỗi : ' + data,
                                type: 'error'
                            });
                        }


                    }

                });
            }
            unloading();
            $.magnificPopup.close();
        }



        function ViewFileSign(id) {

            $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                url: '/Admin/PhienLV/ViewFileSign',
                data:
                {
                    "Id": id
                },
                dataType: "json",
                beforeSend: function () {//alert(id);
                },
                success: function (data) {

                    $("#contentKyso").empty();
                    if (data == "") {

                    }
                    else {
                        var arrdata = data.split(' | ');
                        $('#numberFile').val(arrdata.length);
                        var objbuilder = '';
                        for (let i = 0; i < arrdata.length; i++) {
                            if (i == 0) {
                                objbuilder += ('<object width="100%" id="obj' + i + '" height="100%" data = "data:application/pdf;base64,');
                            } else {
                                objbuilder += ('<object width="100%" id="obj' + i + '" style="display:none;" height="100%" data = "data:application/pdf;base64,');
                            }

                            objbuilder += (arrdata[i]);
                            objbuilder += ('" type="application/pdf" class="internal">');
                            objbuilder += ('<embed src="data:application/pdf;base64,');
                            objbuilder += (arrdata[i]);
                            objbuilder += ('" type="application/pdf"  />');
                            objbuilder += ('</object>');
                        }

                        $("#contentKyso").append(objbuilder);

                    }

                }

            });
        }

    </script>
    <script src="https://code.jquery.com/ui/1.12.1/i18n/datepicker-vi.min.js"></script>
    <script src="~/Scripts/KTGS/js/util_camera.js"></script>
    <script src="~/Scripts/KTGS/js/service.js"></script>
    <script src="~/Scripts/KTGS/js/camera.js?v=13"></script>

}
